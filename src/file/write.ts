import { getName, write } from 'fire-keeper'
import iconv from 'iconv-lite'

import { version } from '../../package.json'

import type { PartialOptions } from '..'
import type Item from '../models/Item'

const generateVersion = () => {
  const group = version.split('.').map(Number)
  return [group[0], group[1], group[2] + 1].join('.')
}

const main = async (
  source: string,
  data: {
    ast: Item[]
    content: string
  },
  options: PartialOptions,
): Promise<void> => {
  const { basename, dirname } = getName(source)

  await write(
    `${dirname}/${basename}.ahk`,
    iconv
      .encode(
        options.metadata
          ? [
              `; Generated by Coffee-AHK/${generateVersion()}`,
              data.content,
            ].join('\n')
          : data.content,
        'utf8',
        {
          addBOM: true,
        },
      )
      .toString(),
  )

  if (options.ast) await write(`${dirname}/${basename}.ast.json`, data.ast)
}

export default main
