# CLAUDE.md

> **å…ƒåŸåˆ™**ï¼šä¸­æ–‡æ–‡æ¡£ Â· 300è¡Œé™åˆ¶ Â· AIå‹å¥½ Â· èŠ‚çœTokens Â· ä»£ç ä¼˜å…ˆäºæ–‡æ¡£ Â· **äººå·¥è¦æ±‚çš„ä¿¡æ¯ä¸å¯è½»æ˜“ç§»é™¤**

> **ğŸ”´ å¼ºåˆ¶è¦æ±‚**ï¼š**å®Œæˆä»»åŠ¡åå¿…é¡»å°†å¯¹è¯ä¸­å‘ç°çš„é‡è¦ä¿¡æ¯ï¼ˆBugã€æ¶æ„å‘ç°ã€è®¾è®¡å†³ç­–ã€å¾…éªŒè¯é—®é¢˜ï¼‰æ›´æ–°åˆ°æœ¬æ–‡ä»¶ç›¸åº”ç« èŠ‚**

## é¡¹ç›®æ¦‚è¿°

**coffee-ahk**: CoffeeScript â†’ AutoHotkey v1 è½¬è¯‘å™¨ã€‚æ”¯æŒç±»ã€æ¨¡å—ã€ç®­å¤´å‡½æ•°ã€è§£æ„ç­‰ç°ä»£è¯­æ³•ã€‚

## å¸¸ç”¨å‘½ä»¤

```bash
pnpm build                 # æ„å»ºï¼ˆæµ‹è¯•å‰å¿…é¡»ï¼‰
pnpm build && pnpm test    # è¿è¡Œå…¨éƒ¨æµ‹è¯•
pnpm test -- <name>        # å•æµ‹è¯•ï¼Œå¦‚ pnpm test -- array
pnpm test -- overwrite     # æ›´æ–° fixture
pnpm lint                  # ä»£ç æ£€æŸ¥
pnpm watch                 # ç›‘å¬ script/**/*.coffee
```

**è°ƒè¯•è½¬è¯‘**ï¼ˆå…ˆ `pnpm build`ï¼‰:

```bash
# âœ… æ­£ç¡®ï¼šæ–‡ä»¶è·¯å¾„ + default export
node -e "
const transpile = require('./dist/index.js').default;
transpile('/tmp/test.coffee', { salt: 'test' }).then(console.log);
"
# âŒ é”™è¯¯
node_modules/.bin/coffee --transpile  # CoffeeScript CLIï¼Œé coffee-ahk
require('./dist/index.js').transpile  # åº”ç”¨ .default
transpile('ä»£ç å­—ç¬¦ä¸²', ...)            # éœ€è¦æ–‡ä»¶è·¯å¾„
```

## æ¶æ„

### è½¬è¯‘æµæ°´çº¿

```
CoffeeScript â†’ tokens â†’ Formatters(tokenâ†’Item) â†’ Processors(ç»“æ„é‡å†™) â†’ Renderer(Itemâ†’AHK)
```

**å…¥å£**: `src/index.ts::transpile(filePath, options)`

### ä¸‰å±‚å¤„ç†

| å±‚         | ä½ç½®                     | ç­¾å               | è¯´æ˜                       |
| ---------- | ------------------------ | ------------------ | -------------------------- |
| Formatters | `src/formatters/` (27ä¸ª) | `(ctx) => boolean` | tokenâ†’Itemï¼Œè¿”å›`true`æ¶ˆè´¹ |
| Processors | `src/processors/` (31ä¸ª) | `(ctx) => void`    | æ‰¹é‡æ”¹å†™ï¼Œ**é¡ºåºæ•æ„Ÿ**     |
| Renderer   | `src/renderer/`          | -                  | Itemâ†’AHKï¼Œ`mapMethod`æ˜ å°„  |

**Processor é¡ºåº**: newLine(#1) â†’ for(#2) â†’ array(#3) â†’ object(#4) â†’ typeof(#5) â†’ instanceof(#6) â†’ variable(#7) â†’ builtIn(#8) â†’ class(#9) â†’ function(#10)

### æ ¸å¿ƒæ•°æ®ç»“æ„

- **Context**: `{token, type, value, content, scope, cache, options}`
- **Item**: ä¸å¯å˜ `{type, value, scope, comment?}` â€” **å¿…é¡»ç”¨ `clone()` å¤åˆ¶**
- **Content**: Item é›†åˆï¼Œç”¨ `.push()` / `.reload()`
  - `toArray()` è¿”å›**æµ…æ‹·è´**ï¼ˆä¸å¯ç›´æ¥ä¿®æ”¹ï¼‰
  - `at(i)` è¿”å› `Item | undefined`ï¼Œç”¨ `at(-1)` å–æœ€åä¸€ä¸ª
  - `pop()` / `shift()` è¿”å› `Item | undefined`
- **Scope**: ç¼©è¿›æ ˆï¼Œéœ€å…‹éš†é˜²æ±¡æŸ“
  - `toArray()` è¿”å›**æµ…æ‹·è´**ï¼ˆä¸å¯ç›´æ¥ä¿®æ”¹ï¼‰
  - `includes(value)` æ£€æŸ¥æ˜¯å¦åŒ…å«æŸ scope
  - `pop()` / `shift()` è¿”å› `ScopeType | undefined`

### å†…ç½®å‡½æ•°

`script/segment/*.coffee` â†’ æ„å»ºç¼–è¯‘ â†’ `src/processors/builtins.gen.ts`

- `changeIndex.coffee` â†’ **ç»Ÿä¸€ç´¢å¼•è½¬æ¢**ï¼ˆ0-basedâ†’1-basedã€è´Ÿç´¢å¼•ã€å˜é‡ç´¢å¼•ï¼‰
- `typeof.coffee` â†’ ç±»å‹æ£€æµ‹

**ç´¢å¼•å¤„ç†ç­–ç•¥ (v0.0.74+)**:

- **ç¼–è¯‘æ—¶ä¼˜åŒ–**: å•ä¸ªéè´Ÿæ•´æ•°å­—é¢é‡ç›´æ¥ +1ï¼ˆ`arr[0]` â†’ `arr[1]`ï¼‰ï¼Œæ— å‡½æ•°è°ƒç”¨
- **è¿è¡Œæ—¶å¤„ç†**: è´Ÿç´¢å¼•ã€å˜é‡ã€è¡¨è¾¾å¼é€šè¿‡ `â„“ci` å‡½æ•°å¤„ç†ï¼ˆ`arr[-1]` â†’ `â„“ci_salt(arr, -1)`ï¼‰
- å­—ç¬¦ä¸²é”®ç›´æ¥ä½¿ç”¨ä¸è½¬æ¢

**å†…éƒ¨å˜é‡å‘½å** (`src/constants.ts`):

- ä½¿ç”¨ Unicode å‰ç¼€ `â„“` (U+2113, script small l) èŠ‚çœå­—ç¬¦ã€é¿å…å†²çª
- `Î»` â€” é—­åŒ…ä¸Šä¸‹æ–‡ | `â„“ci` â€” ç´¢å¼•è½¬æ¢ | `â„“type` â€” typeof
- `â„“array`/`â„“object` â€” è§£æ„ä¸´æ—¶å˜é‡ | `â„“this` â€” this å‚æ•°æ›¿æ¢
- `â„“i`/`â„“k` â€” for å¾ªç¯é»˜è®¤ç´¢å¼•/é”®

**ç¦æ­¢ç›´æ¥å†™ .ahk**ï¼Œå¿…é¡»å†™ .coffeeã€‚

### æ¨¡å—å†…è”ç³»ç»Ÿ

**æµç¨‹** (`src/file/include/`): import æ›¿æ¢ â†’ export è§£æ â†’ æ‹“æ‰‘æ’åº â†’ æ¨¡å—ç»„è£…

**å…³é”®æ–‡ä»¶**:

- `cache.ts` â€” æ¨¡å—ç¼“å­˜ã€å¾ªç¯ä¾èµ–æ£€æµ‹ã€æ‹“æ‰‘æ’åº (Kahn ç®—æ³•)
- `source-resolver.ts` â€” è·¯å¾„è§£æ (ç›¸å¯¹è·¯å¾„ã€node_modulesã€package.json main)
- `transformer/transform.ts` â€” export è§£æã€é—­åŒ…åŒ…è£…
- `transformer/replace-anchor.ts` â€” import è¯­å¥æ›¿æ¢ä¸ºå˜é‡èµ‹å€¼

**ç‰¹æ€§**:

- å¾ªç¯ä¾èµ–æ£€æµ‹ (DFS)ï¼Œå‘ç°æ—¶æŠ›å‡ºæ¸…æ™°é”™è¯¯è·¯å¾„
- å‰¯ä½œç”¨æ¨¡å— (`import './foo'`) å‚ä¸ä¾èµ–æ’åºï¼Œç¡®ä¿æ‰§è¡Œé¡ºåº
- æ”¯æŒ `export default`ã€`export { a, b }`ã€`export { a: expr }`

**æ³¨æ„**: `parseExportsFromCoffee()` éå†æ¨¡å—è¡Œæ—¶ **å¿…é¡»ç”¨ `line === undefined` åˆ¤æ–­ç»“æŸ**ï¼ˆç©ºå­—ç¬¦ä¸²æ˜¯ falsyï¼‰

## ä»£ç è§„èŒƒ

```typescript
// âœ… æ­£ç¡®
const item = array.at(i); // æ•°ç»„ç”¨ at()
if (!item) return; // ç©ºå€¼æ£€æŸ¥
const s = `${a}${b}`; // æ¨¡æ¿å­—ç¬¦ä¸²
const flag = x?.is("a") === true || x?.is("b") === true; // å¸ƒå°”é“¾

// âŒ é”™è¯¯
array[i] as Item; // ç¦ as æ–­è¨€
a + b; // ç¦ + æ‹¼å­—ç¬¦ä¸²ï¼ˆç”¨æ¨¡æ¿ï¼‰
x?.is("a") || x?.is("b"); // ESLint è­¦å‘Š
```

TypeScript ä¸¥æ ¼æ¨¡å¼: `noImplicitAny`, `noUncheckedIndexedAccess`

## å…³é”®çº¦æŸ

- **å¤§å°å†™**: AHK ä¸æ•æ„Ÿï¼›ç±»åç”¨å…¨è§’ (`Animal` â†’ `ï¼¡nimal`)
- **è¡Œé•¿**: æœ€å¤§ 200 å­—ç¬¦ï¼Œ`splitAtCommas()` è‡ªåŠ¨æ¢è¡Œ
- **ç¼–ç **: UTF-8 with BOM
- **ç¦æ­¢è¯­æ³•**: `?.` `??` `||=` `&&=` `//` `%%` `in` `delete` â€” è§ `data/forbidden.yaml`
- **æµ‹è¯• salt**: å¿…é¡»å›ºå®š `salt: 'ahk'`
- **æ•°ç»„/å¯¹è±¡ä¸å¯åŒºåˆ†**: AHK v1 ä¸­ `[]` æ˜¯ `{}` çš„è¯­æ³•ç³–ï¼Œ`[a,b]` ç­‰åŒäº `{1:a, 2:b}`ï¼Œæ— åŸç”Ÿæ–¹æ³•åŒºåˆ†ä¸¤è€…

### ç´¢å¼•è½¬æ¢é™åˆ¶

`â„“ci` å‡è®¾ï¼š**æ•°ç»„ç”¨æ•°å­—ç´¢å¼•ï¼Œå¯¹è±¡ç”¨å­—ç¬¦ä¸²ç´¢å¼•**ã€‚

| åœºæ™¯                    | è¡Œä¸º   | ç»“æœ                       |
| ----------------------- | ------ | -------------------------- |
| `arr[0]`                | è½¬æ¢   | âœ… `arr[1]`                |
| `obj["key"]`            | ä¸è½¬æ¢ | âœ… `obj["key"]`            |
| `obj[0]` (å¯¹è±¡ç”¨æ•°å­—é”®) | è½¬æ¢   | âš ï¸ `obj[1]` â€” **å¯èƒ½é”™è¯¯** |

**AHK v1 é”®ç±»å‹ç»†èŠ‚**: `obj[0]` å’Œ `obj["0"]` è®¿é—®**ä¸åŒçš„é”®**ï¼ˆæ•°å­—é”® vs å­—ç¬¦ä¸²é”®ï¼‰ã€‚ä½†å˜é‡ä¾‹å¤–ï¼š`i := "0"; obj[i]` è®¿é—®æ•°å­—é”®ï¼ˆçº¯æ•°å­—å­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢ï¼‰ã€‚

**è®¾è®¡å†³ç­–**: ä¼˜å…ˆä¿è¯ CoffeeScript æ•°ç»„è¯­ä¹‰ï¼ˆ0-basedï¼‰ã€‚å¯¹è±¡æ•°å­—é”®åœºæ™¯ï¼šç”¨ `obj["0"]` è®¿é—®å­—ç¬¦ä¸²é”®ï¼Œæˆ–ç”¨ Native åµŒå…¥ç›´æ¥å†™ AHKã€‚

## å¸¸è§é™·é˜±

| é”™è¯¯                        | åæœ           | è§£å†³                       |
| --------------------------- | -------------- | -------------------------- |
| Formatter æœªè¿”å› `true`     | token é‡å¤å¤„ç† | æ¶ˆè´¹åè¿”å› `true`          |
| ç›´æ¥æ”¹ `toArray()` è¿”å›å€¼   | ä¸å½±å“åŸæ•°æ®   | ç”¨ `.reload()` / `.push()` |
| Processor é¡ºåºé”™            | è½¬æ¢é”™è¯¯       | æŒ‰åºå·æ’å…¥                 |
| æµ‹è¯•å‰æœª build              | æµ‹æ—§ä»£ç        | `pnpm build && pnpm test`  |
| `new Item()` ä¸ç”¨ `clone()` | ä¸¢å¤± comment   | ç”¨ `clone()`               |
| `!line` åˆ¤æ–­ç©ºè¡Œ            | å¾ªç¯æå‰ä¸­æ–­   | ç”¨ `line === undefined`    |
| post-if (`y if x`)          | forbidden      | ç”¨ `if x then y`           |

## æ–°åŠŸèƒ½å¼€å‘

| åœºæ™¯          | å±‚                    | ç¤ºä¾‹             |
| ------------- | --------------------- | ---------------- |
| å• token è¯­æ³• | Formatter             | `?.` â†’ forbidden |
| å¤šè¡Œç»“æ„é‡å†™  | Processor             | æ•°ç»„è§£æ„         |
| éœ€å›æº¯        | Formatter + Processor | éšå¼è¿”å›         |

**æ·»åŠ  Formatter**: `src/formatters/<name>.ts` â†’ æ³¨å†Œ `formattersMap` â†’ æ·»åŠ æµ‹è¯•
**æ·»åŠ  Processor**: æŒ‰é¡ºåºæ’å…¥ï¼ˆä¾èµ– newLine æ”¾ #1 åï¼Œç»“æ„é‡å†™æ”¾ builtIn å‰ï¼‰

## æ³¨é‡Šç³»ç»Ÿ

**å¯ç”¨**: `comments: true`ï¼ˆé»˜è®¤ `false`ï¼‰

**æµç¨‹**: Formatter é˜¶æ®µè¯»å– token comments â†’ åˆ¤æ–­ standalone/inline â†’ é™„åŠ åˆ° `Item.comment[]` â†’ Renderer æ¸²æŸ“

**é™åˆ¶**: CoffeeScript å°†æ³¨é‡Šé™„åŠ åˆ°ä¸‹ä¸€ä¸ª tokenï¼Œéè¯­å¥å¼€å§‹

## å·²çŸ¥é—®é¢˜

### å·²ä¿®å¤ (2025-11-24)

- **Export è§£æç©ºè¡Œä¸­æ–­**: `if (!nextLine) break` é‡ç©ºå­—ç¬¦ä¸²ä¸­æ–­ â†’ æ”¹ç”¨ `nextLine === undefined`
- **ç±»å‹æ³¨é‡Šå¹²æ‰°**: export å‰çš„ `###* @type ###` éœ€è·³è¿‡

### å·²è§£å†³ (2025-11-25)

- **é“¾å¼è´Ÿç´¢å¼•**: `nested[0][-1]` ä¹‹å‰æ— æ³•æ­£ç¡®è½¬æ¢ï¼ˆarrayItems æ”¶é›†ä¸å®Œæ•´ï¼‰
- **è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ `â„“ci` è¿è¡Œæ—¶å‡½æ•°å¤„ç†æ‰€æœ‰æ•°å­—ç´¢å¼•ï¼Œä»å³åˆ°å·¦å¤„ç†é¿å…ä¿®æ”¹å¹²æ‰°
- **æ”¶é›†é€»è¾‘**: `collectArrayExpression()` æ”¯æŒå›æº¯ç´¢å¼•è¡¨è¾¾å¼ï¼Œæ­£ç¡®æ”¶é›† `nested[0]` æ•´ä½“

### API ä¸€è‡´æ€§æ”¹è¿› (2025-11-26)

- **Content/Scope**: `list` getter â†’ `toArray()` æ–¹æ³•ï¼Œæ˜ç¡®è¿”å›æµ…æ‹·è´è¯­ä¹‰
- **Content ç±»**: ç§»é™¤ `last` getterï¼Œç»Ÿä¸€ç”¨ `at(-1)`ï¼›`pop()`/`shift()` è¿”å› `undefined` è€Œéç©º Item
- **Scope ç±»**: æ·»åŠ  `includes()` æ–¹æ³•ï¼›`pop()`/`shift()` è¿”å› `undefined` è€Œéç©ºå­—ç¬¦ä¸²ï¼›ä¼˜åŒ– `isEqual()` é¿å…æ•°ç»„å¤åˆ¶
- **ç§»é™¤å†—ä½™æ£€æŸ¥**: `identifier.ts` ä¸­ç±»åä¸å˜é‡å†²çªæ£€æŸ¥å·²ç§»é™¤ï¼ˆå…¨è§’æ–¹æ¡ˆå·²å¤„ç†ï¼‰

### é—­åŒ…å®ç° (2025-11-26)

**é—®é¢˜**: å†…å±‚å‡½æ•°æ— æ³•æ­£ç¡®è¯»å–/ä¿®æ”¹å¤–å±‚å‡½æ•°å˜é‡ï¼ˆAHK v1 `.Bind()` æ˜¯å€¼æ‹·è´ï¼‰

**è§£å†³æ–¹æ¡ˆ**: `Î»` (lambda) å¯¹è±¡æ¨¡å¼

- æ‰€æœ‰éå…¨å±€å˜é‡/å‚æ•°å­˜å…¥ `Î»` å¯¹è±¡
- å†…å±‚å‡½æ•°é€šè¿‡ `.Bind(Î»)` æ¥æ”¶ä¸Šä¸‹æ–‡å¼•ç”¨
- å˜é‡è®¿é—®è½¬æ¢ä¸º `Î».xxx`
- ä½¿ç”¨ `Î»` (U+03BB) è€Œé `__ctx__`ï¼šè¯­ä¹‰ç²¾å‡†ï¼ˆlambda = é—­åŒ…ï¼‰ï¼Œä¸”èŠ‚çœ 6 å­—ç¬¦/æ¬¡

```coffee
# è¾“å…¥
fn = (a) ->
  b = 1
  inner = -> a + b
  inner()

# è¾“å‡º
ahk_2(a) {
  Î»:={a: a}
  Î».b := 1
  Î».inner := Func("ahk_1").Bind(Î»)
  Î».inner.Call()
}
ahk_1(Î») {
  if(!Î»)Î»:={}
  return Î».a + Î».b
}
```

**å…³é”®æ–‡ä»¶**: `src/processors/function/ctx-transform.ts`

**è·³è¿‡ ctx çš„æƒ…å†µ**:

- å…¨å±€å˜é‡ (`ctx.cache.global`)
- `this` å…³é”®å­—
- `â„“xxx` å†…éƒ¨æ ‡è¯†ç¬¦ï¼ˆä»¥ `â„“` å¼€å¤´ï¼‰
- é¦–å­—æ¯å¤§å†™æ ‡è¯†ç¬¦ (ç±»åã€å†…ç½®å‡½æ•°)
- éå‡½æ•°ä½œç”¨åŸŸå†…çš„æ ‡è¯†ç¬¦

**å†…ç½®å‡½æ•°ä¿æŠ¤**: `salt='salt'` ç¼–è¯‘çš„æ®µè½ä¸åº”ç”¨ ctx è½¬æ¢

### Class ä¸ Export å†²çª (2025-11-26)

**é—®é¢˜**: AHK v1 çš„ class å¿…é¡»åœ¨é¡¶å±‚å®šä¹‰ï¼Œä¸èƒ½åµŒå¥—åœ¨å‡½æ•°/é—­åŒ…å†…ã€‚è€Œ export æ¨¡å—ä¼šè¢« `do ->` åŒ…è£¹ä»¥éš”ç¦»ä½œç”¨åŸŸï¼Œå¯¼è‡´ class æ— æ³•æ­£å¸¸å·¥ä½œã€‚

**å˜é€šæ–¹æ¡ˆ**: å°† class å®šä¹‰å’Œ export åˆ†ç¦»åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼š

```coffee
# animal.coffee â€” çº¯ class å®šä¹‰ï¼Œä¸ä½¿ç”¨ export
class Animal
  constructor: (@name) ->
  speak: -> console.log @name

# index.coffee â€” ä¸»æ–‡ä»¶ï¼Œimport class æ–‡ä»¶
import './animal'  # å‰¯ä½œç”¨å¯¼å…¥ï¼Œclass å®šä¹‰åœ¨é¡¶å±‚æ‰§è¡Œ
dog = new Animal('Dog')
```

**åŸç†**: å‰¯ä½œç”¨å¯¼å…¥ (`import './xxx'`) çš„ä»£ç ç›´æ¥å†…è”åˆ°ä¸»æ–‡ä»¶é¡¶å±‚ï¼Œä¸è¢«é—­åŒ…åŒ…è£¹ï¼Œå› æ­¤ class å¯ä»¥æ­£å¸¸å®šä¹‰ã€‚

**é™åˆ¶**: æ— æ³•é€šè¿‡ `export default Animal` å¯¼å‡º class æœ¬èº«ï¼Œåªèƒ½ä¾èµ–å‰¯ä½œç”¨å¯¼å…¥å class åè‡ªåŠ¨æˆä¸ºå…¨å±€å¯ç”¨ã€‚

### AHK v1 è¯­æ³•å…¼å®¹ä¿®å¤ (2025-11-26)

| é—®é¢˜                | è§£å†³æ–¹æ¡ˆ                                                              |
| ------------------- | --------------------------------------------------------------------- |
| `this` ä½œä¸ºå‚æ•°å   | ç±»æ–¹æ³•å‚æ•°ç”¨ `â„“this`ï¼Œå‡½æ•°ä½“å¼€å¤´åŠ  `this := â„“this`                    |
| å¯¹è±¡é”®åè¡¨è¾¾å¼      | `shouldUseCtx` è·³è¿‡ object scope ä¸­åè·Ÿ `:` çš„æ ‡è¯†ç¬¦                  |
| catch å˜é‡å‰ç¼€      | `collectCatchVars` æ”¶é›† catch å˜é‡åï¼Œåœ¨ catch scope å†…è·³è¿‡ ctx è½¬æ¢  |
| `do => @a` thisæ•è· | `arrow.ts` æ ‡è®° `__mark:do-fat__`ï¼Œ`do.ts` åœ¨ `.Call()` ä¸­ä¼ å…¥ `this` |

## æäº¤æ£€æŸ¥

1. `pnpm build && pnpm test` â€” 41 E2E + 20 unit + 23 error å…¨è¿‡
2. `pnpm lint` â€” 0 errors
3. æ–°åŠŸèƒ½æœ‰æµ‹è¯•
4. **é‡è¦å‘ç°å·²æ›´æ–°åˆ°æœ¬æ–‡ä»¶**
